<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MotorEast EV-Ready Condo Rebate Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useCallback, useEffect } = React;

        // ============================================
        // SUPABASE CONFIGURATION
        // ============================================
        // The anon key is safe to expose - RLS policies protect your data
        const SUPABASE_URL = 'https://sbyhlwkiuoeuackkegfv.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNieWhsd2tpdW9ldWFja2tlZ2Z2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU1OTM5ODIsImV4cCI6MjA4MTE2OTk4Mn0.9v7tX0xLImQqv5mjLT11bDhdtiYHrEBn3eulB53wc0c';

        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Set to true once you've configured Supabase and run the schema
        const USE_SUPABASE = true; // LIVE MODE ENABLED

        // ============================================
        // GEMINI AI CONFIGURATION (Free tier: 1,500 requests/day)
        // Get your free API key at: https://makersuite.google.com/app/apikey
        // ============================================
        const GEMINI_API_KEY = 'AIzaSyCr_0n4mpoqjxd2g9JoKdJCYU8lVP5RYkw';
        const GEMINI_MODEL = 'gemini-2.5-flash'; // Gemini 2.5 Flash (free tier)

        // Receipt analysis function using Gemini Vision
        const analyzeReceipt = async (file) => {
            if (!GEMINI_API_KEY) {
                return { error: 'Gemini API key not configured' };
            }

            try {
                // Convert file to base64
                const base64 = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });

                const mimeType = file.type || 'image/jpeg';

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                {
                                    text: `Analyze this receipt image and extract information. Respond ONLY with a valid JSON object (no markdown, no code blocks), with these exact fields:
{
  "isEVCharging": true/false (is this a receipt for electric vehicle charging?),
  "confidence": "high"/"medium"/"low" (how confident are you this is an EV charging receipt?),
  "amount": number or null (total amount paid in SGD, just the number),
  "currency": "SGD" or detected currency,
  "operator": "string" or null (charging operator/provider name like "Charge+", "SP Group", "Shell Recharge", "CDG Engie", "BlueSG", etc.),
  "date": "YYYY-MM-DD" or null (transaction date),
  "location": "string" or null (charging location if visible),
  "vehicleInfo": "string" or null (any vehicle/registration info if visible),
  "reason": "string" (brief explanation of why this is/isn't an EV charging receipt)
}

Important:
- Singapore Dollar (SGD/S$/$) is the expected currency
- Common Singapore EV charging operators: Charge+, SP Group, Shell Recharge, CDG Engie, BlueSG, Volt, Greenlots
- Look for keywords: kWh, charging, EV, electric vehicle, charging station`
                                },
                                {
                                    inline_data: {
                                        mime_type: mimeType,
                                        data: base64
                                    }
                                }
                            ]
                        }],
                        generationConfig: {
                            temperature: 0.1,
                            maxOutputTokens: 1024
                        }
                    })
                });

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error.message || 'Gemini API error');
                }

                const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';

                // Parse JSON from response (handle potential markdown code blocks)
                let jsonStr = text.trim();
                if (jsonStr.startsWith('```')) {
                    jsonStr = jsonStr.replace(/```json?\n?/g, '').replace(/```/g, '');
                }

                const result = JSON.parse(jsonStr);
                return { success: true, data: result };

            } catch (err) {
                console.error('Receipt analysis error:', err);
                return { error: err.message || 'Failed to analyze receipt' };
            }
        };

        // ============================================
        // SUPABASE API FUNCTIONS
        // ============================================
        const db = {
            // AUTH
            async signUp(email, password, metadata) {
                const { data, error } = await supabase.auth.signUp({
                    email,
                    password,
                    options: { data: metadata }
                });
                if (error) throw error;
                return data;
            },

            async signIn(email, password) {
                const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) throw error;
                return data;
            },

            async signOut() {
                const { error } = await supabase.auth.signOut();
                if (error) throw error;
            },

            async getSession() {
                const { data: { session } } = await supabase.auth.getSession();
                return session;
            },

            async getProfile(userId) {
                const { data, error } = await supabase
                    .from('profiles')
                    .select('*, condo:condos(*)')
                    .eq('id', userId)
                    .single();
                if (error) throw error;
                return data;
            },

            async updateProfile(userId, updates) {
                const { data, error } = await supabase
                    .from('profiles')
                    .update(updates)
                    .eq('id', userId)
                    .select()
                    .single();
                if (error) throw error;
                return data;
            },

            // CONDOS
            async getCondos() {
                const { data, error } = await supabase
                    .from('condos')
                    .select('*')
                    .order('name');
                if (error) throw error;
                return data;
            },

            // CLAIMS
            async submitClaim(claimData, userId, condoId, rebateRate, receiptFile) {
                const rebateAmount = claimData.amount * rebateRate;

                // Upload receipt if provided
                let receiptPath = null;
                if (receiptFile) {
                    const fileName = `${userId}/${Date.now()}-${receiptFile.name}`;
                    const { data: uploadData, error: uploadError } = await supabase.storage
                        .from('receipts')
                        .upload(fileName, receiptFile);
                    if (uploadError) console.error('Receipt upload error:', uploadError);
                    else receiptPath = uploadData.path;
                }

                const { data, error } = await supabase
                    .from('claims')
                    .insert({
                        user_id: userId,
                        condo_id: condoId,
                        charge_date: claimData.date,
                        operator: claimData.operator,
                        amount: claimData.amount,
                        rebate_rate: rebateRate,
                        rebate_amount: rebateAmount,
                        receipt_path: receiptPath,
                        status: claimData.amount > 300 ? 'flagged' : 'pending'
                    })
                    .select()
                    .single();
                if (error) throw error;
                return data;
            },

            async getUserClaims(userId) {
                const { data, error } = await supabase
                    .from('claims')
                    .select('*, condo:condos(name, tier)')
                    .eq('user_id', userId)
                    .order('charge_date', { ascending: false });
                if (error) throw error;
                return data;
            },

            async getAllClaims() {
                const { data, error } = await supabase
                    .from('claims')
                    .select(`
                        *,
                        profile:profiles!user_id(name, email, vehicle_number),
                        condo:condos!condo_id(name, tier)
                    `)
                    .order('created_at', { ascending: false });
                if (error) throw error;
                return data.map(c => ({
                    id: c.id,
                    userId: c.user_id,
                    date: c.charge_date,
                    operator: c.operator,
                    amount: parseFloat(c.amount),
                    rebateRate: parseFloat(c.rebate_rate),
                    rebate: parseFloat(c.rebate_amount),
                    status: c.status,
                    participant: c.profile?.name,
                    email: c.profile?.email,
                    vehicle: c.profile?.vehicle_number,
                    condo: c.condo?.name,
                    receiptPath: c.receipt_path
                }));
            },

            async updateClaimStatus(claimId, status, reviewerId) {
                const { data, error } = await supabase
                    .from('claims')
                    .update({
                        status,
                        reviewed_by: reviewerId,
                        reviewed_at: new Date().toISOString()
                    })
                    .eq('id', claimId)
                    .select()
                    .single();
                if (error) throw error;
                return data;
            },

            async getYTDRebate(userId) {
                const year = new Date().getFullYear();
                const { data, error } = await supabase
                    .from('claims')
                    .select('rebate_amount')
                    .eq('user_id', userId)
                    .eq('status', 'approved')
                    .gte('charge_date', `${year}-01-01`);
                if (error) throw error;
                return data.reduce((sum, c) => sum + parseFloat(c.rebate_amount), 0);
            },

            // STORAGE
            async uploadReceipt(userId, file) {
                const fileName = `${userId}/${Date.now()}-${file.name}`;
                const { data, error } = await supabase.storage
                    .from('receipts')
                    .upload(fileName, file);
                if (error) throw error;
                return data.path;
            },

            async getReceiptUrl(path) {
                if (!path) return null;
                const { data } = supabase.storage.from('receipts').getPublicUrl(path);
                return data.publicUrl;
            }
        };

        // Icon components using Lucide
        const Icon = ({ name, className }) => {
            const ref = React.useRef(null);
            useEffect(() => {
                if (ref.current) {
                    ref.current.innerHTML = '';
                    const icon = lucide.createElement(lucide.icons[name]);
                    ref.current.appendChild(icon);
                }
            }, [name]);
            return <span ref={ref} className={`inline-flex ${className || ''}`} style={{ width: '1em', height: '1em' }} />;
        };

        // Simple icon components
        const Upload = ({ className }) => (
            <svg className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
            </svg>
        );
        const CheckCircle = ({ className }) => (
            <svg className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        );
        const XCircle = ({ className }) => (
            <svg className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        );
        const AlertTriangle = ({ className }) => (
            <svg className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
        );
        const Clock = ({ className }) => (
            <svg className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        );
        const Download = ({ className }) => (
            <svg className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
            </svg>
        );
        const ChevronRight = ({ className }) => (
            <svg className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M9 5l7 7-7 7" />
            </svg>
        );
        const Zap = ({ className }) => (
            <svg className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" />
            </svg>
        );
        const Users = ({ className }) => (
            <svg className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
            </svg>
        );
        const LogOut = ({ className }) => (
            <svg className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
            </svg>
        );
        const X = ({ className }) => (
            <svg className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
        );
        const Eye = ({ className }) => (
            <svg className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                <path strokeLinecap="round" strokeLinejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
            </svg>
        );
        const FileText = ({ className }) => (
            <svg className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
        );
        const DollarSign = ({ className }) => (
            <svg className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        );
        const Building = ({ className }) => (
            <svg className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
            </svg>
        );
        const TrendingUp = ({ className }) => (
            <svg className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
            </svg>
        );
        const Search = ({ className }) => (
            <svg className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
        );
        const Calendar = ({ className }) => (
            <svg className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
        );
        const Mail = ({ className }) => (
            <svg className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
            </svg>
        );
        const Copy = ({ className }) => (
            <svg className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
            </svg>
        );
        const UserPlus = ({ className }) => (
            <svg className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
            </svg>
        );
        const BarChart = ({ className }) => (
            <svg className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
            </svg>
        );

        // Mock data - Extended with more months for accumulation view
        const initialClaims = [
            { id: 1, date: '2024-12-05', operator: 'Charge+', amount: 45.60, rebateRate: 0.15, rebate: 6.84, status: 'approved', participant: 'John Tan', condo: 'The Reef @ KPE', vehicle: 'SMA1234B', email: 'john.tan@email.com' },
            { id: 2, date: '2024-12-03', operator: 'SP Group', amount: 38.90, rebateRate: 0.15, rebate: 5.84, status: 'approved', participant: 'John Tan', condo: 'The Reef @ KPE', vehicle: 'SMA1234B', email: 'john.tan@email.com' },
            { id: 3, date: '2024-12-01', operator: 'Shell Recharge', amount: 52.30, rebateRate: 0.15, rebate: 7.85, status: 'pending', participant: 'Mary Lim', condo: 'The Reef @ KPE', vehicle: 'SMB5678C', email: 'mary.lim@email.com' },
            { id: 4, date: '2024-11-28', operator: 'Charge+', amount: 41.20, rebateRate: 0.12, rebate: 4.94, status: 'approved', participant: 'David Wong', condo: 'Parc Esta', vehicle: 'SMC9012D', email: 'david.wong@email.com' },
            { id: 5, date: '2024-11-25', operator: 'SP Group', amount: 310.00, rebateRate: 0.15, rebate: 46.50, status: 'flagged', participant: 'Sarah Chen', condo: 'The Reef @ KPE', vehicle: 'SMD3456E', email: 'sarah.chen@email.com' },
            { id: 6, date: '2024-11-15', operator: 'Charge+', amount: 52.00, rebateRate: 0.15, rebate: 7.80, status: 'approved', participant: 'John Tan', condo: 'The Reef @ KPE', vehicle: 'SMA1234B', email: 'john.tan@email.com' },
            { id: 7, date: '2024-11-08', operator: 'Shell Recharge', amount: 48.50, rebateRate: 0.15, rebate: 7.28, status: 'approved', participant: 'John Tan', condo: 'The Reef @ KPE', vehicle: 'SMA1234B', email: 'john.tan@email.com' },
            { id: 8, date: '2024-10-22', operator: 'SP Group', amount: 55.00, rebateRate: 0.15, rebate: 8.25, status: 'approved', participant: 'John Tan', condo: 'The Reef @ KPE', vehicle: 'SMA1234B', email: 'john.tan@email.com' },
            { id: 9, date: '2024-10-10', operator: 'Charge+', amount: 42.30, rebateRate: 0.15, rebate: 6.35, status: 'approved', participant: 'John Tan', condo: 'The Reef @ KPE', vehicle: 'SMA1234B', email: 'john.tan@email.com' },
            { id: 10, date: '2024-10-05', operator: 'Charge+', amount: 38.00, rebateRate: 0.12, rebate: 4.56, status: 'approved', participant: 'David Wong', condo: 'Parc Esta', vehicle: 'SMC9012D', email: 'david.wong@email.com' },
        ];

        const condoData = [
            { name: 'The Reef @ KPE', owners: 14, tier: 'Gold', rate: 0.15, duration: 3, monthlyCharging: 890 },
            { name: 'Parc Esta', owners: 8, tier: 'Silver', rate: 0.12, duration: 2, monthlyCharging: 520 },
            { name: 'Treasure @ Tampines', owners: 5, tier: 'Bronze', rate: 0.10, duration: 2, monthlyCharging: 310 },
        ];

        const tierConfig = {
            Bronze: { min: 3, max: 5, rate: 0.10, duration: 2, color: '#CD7F32', next: 'Silver', nextMin: 6 },
            Silver: { min: 6, max: 10, rate: 0.12, duration: 2, color: '#C0C0C0', next: 'Gold', nextMin: 11 },
            Gold: { min: 11, max: 15, rate: 0.15, duration: 3, color: '#FFD700', next: 'Platinum', nextMin: 16 },
            Platinum: { min: 16, max: Infinity, rate: 0.20, duration: 3, color: '#E5E4E2', next: null, nextMin: null },
        };

        // Utility Components
        const StatusBadge = ({ status }) => {
            const styles = {
                approved: 'bg-emerald-100 text-emerald-700 border-emerald-200',
                pending: 'bg-amber-100 text-amber-700 border-amber-200',
                rejected: 'bg-red-100 text-red-700 border-red-200',
                flagged: 'bg-orange-100 text-orange-700 border-orange-200',
            };
            const icons = {
                approved: <CheckCircle className="w-3 h-3" />,
                pending: <Clock className="w-3 h-3" />,
                rejected: <XCircle className="w-3 h-3" />,
                flagged: <Eye className="w-3 h-3" />,
            };
            return (
                <span className={`inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium border ${styles[status]}`}>
                    {icons[status]}
                    {status.charAt(0).toUpperCase() + status.slice(1)}
                </span>
            );
        };

        const TierBadge = ({ tier }) => {
            const config = tierConfig[tier];
            return (
                <span 
                    className="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-bold border-2"
                    style={{ 
                        backgroundColor: `${config.color}20`, 
                        borderColor: config.color,
                        color: tier === 'Platinum' ? '#1a1a2e' : config.color 
                    }}
                >
                    <Zap className="w-3 h-3" />
                    {tier}
                </span>
            );
        };

        const ProgressBar = ({ current, max }) => {
            const percentage = Math.min((current / max) * 100, 100);
            return (
                <div className="w-full">
                    <div className="flex justify-between text-sm mb-1">
                        <span className="text-slate-600">Used</span>
                        <span className="font-semibold text-slate-800">${current.toFixed(2)} / ${max.toFixed(2)}</span>
                    </div>
                    <div className="h-3 bg-slate-200 rounded-full overflow-hidden">
                        <div
                            className="h-full bg-gradient-to-r from-amber-500 to-amber-400 rounded-full transition-all duration-500"
                            style={{ width: `${percentage}%` }}
                        />
                    </div>
                    <p className="text-xs text-slate-500 mt-1">${(max - current).toFixed(2)} remaining</p>
                </div>
            );
        };

        // Monthly Accumulation Component
        const MonthlyAccumulation = ({ claims, onClose }) => {
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

            // Group claims by month
            const monthlyData = claims.reduce((acc, claim) => {
                const date = new Date(claim.date);
                const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                const monthLabel = `${monthNames[date.getMonth()]} ${date.getFullYear()}`;

                if (!acc[key]) {
                    acc[key] = { key, label: monthLabel, claims: [], totalAmount: 0, totalRebate: 0, approvedRebate: 0 };
                }
                acc[key].claims.push(claim);
                acc[key].totalAmount += claim.amount;
                acc[key].totalRebate += claim.rebate;
                if (claim.status === 'approved') {
                    acc[key].approvedRebate += claim.rebate;
                }
                return acc;
            }, {});

            const sortedMonths = Object.values(monthlyData).sort((a, b) => b.key.localeCompare(a.key));
            const maxRebate = Math.max(...sortedMonths.map(m => m.totalRebate));

            return (
                <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-hidden">
                        <div className="p-6 border-b border-slate-200 flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 bg-amber-100 rounded-xl flex items-center justify-center">
                                    <BarChart className="w-5 h-5 text-amber-600" />
                                </div>
                                <div>
                                    <h3 className="text-xl font-bold text-slate-800">Monthly Accumulation</h3>
                                    <p className="text-sm text-slate-500">Your rebate history by month</p>
                                </div>
                            </div>
                            <button onClick={onClose} className="p-2 hover:bg-slate-100 rounded-lg">
                                <X className="w-5 h-5" />
                            </button>
                        </div>

                        <div className="p-6 overflow-y-auto max-h-[60vh]">
                            <div className="space-y-4">
                                {sortedMonths.map(month => (
                                    <div key={month.key} className="bg-slate-50 rounded-xl p-4 border border-slate-200">
                                        <div className="flex items-center justify-between mb-3">
                                            <div className="flex items-center gap-2">
                                                <Calendar className="w-5 h-5 text-slate-400" />
                                                <span className="font-semibold text-slate-800">{month.label}</span>
                                            </div>
                                            <span className="text-sm text-slate-500">{month.claims.length} claim{month.claims.length !== 1 ? 's' : ''}</span>
                                        </div>

                                        {/* Visual bar */}
                                        <div className="h-4 bg-slate-200 rounded-full overflow-hidden mb-3">
                                            <div
                                                className="h-full bg-gradient-to-r from-amber-500 to-orange-500 rounded-full transition-all duration-500"
                                                style={{ width: `${(month.totalRebate / maxRebate) * 100}%` }}
                                            />
                                        </div>

                                        <div className="grid grid-cols-3 gap-4 text-center">
                                            <div>
                                                <p className="text-xs text-slate-500">Charged</p>
                                                <p className="font-bold text-slate-800">${month.totalAmount.toFixed(2)}</p>
                                            </div>
                                            <div>
                                                <p className="text-xs text-slate-500">Total Rebate</p>
                                                <p className="font-bold text-amber-600">${month.totalRebate.toFixed(2)}</p>
                                            </div>
                                            <div>
                                                <p className="text-xs text-slate-500">Approved</p>
                                                <p className="font-bold text-emerald-600">${month.approvedRebate.toFixed(2)}</p>
                                            </div>
                                        </div>

                                        {/* Breakdown */}
                                        <div className="mt-3 pt-3 border-t border-slate-200">
                                            <div className="space-y-2">
                                                {month.claims.map(claim => (
                                                    <div key={claim.id} className="flex items-center justify-between text-sm">
                                                        <div className="flex items-center gap-2">
                                                            <span className="text-slate-500">{claim.date}</span>
                                                            <span className="text-slate-700">{claim.operator}</span>
                                                        </div>
                                                        <div className="flex items-center gap-3">
                                                            <span className="text-slate-600">${claim.amount.toFixed(2)}</span>
                                                            <span className="text-emerald-600 font-medium">+${claim.rebate.toFixed(2)}</span>
                                                            <StatusBadge status={claim.status} />
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        <div className="p-4 border-t border-slate-200 bg-slate-50">
                            <div className="flex items-center justify-between">
                                <span className="text-sm text-slate-500">All-time total rebate</span>
                                <span className="text-xl font-bold text-amber-600">
                                    ${sortedMonths.reduce((sum, m) => sum + m.totalRebate, 0).toFixed(2)}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Email Template Generator Component (Admin)
        const EmailTemplateGenerator = ({ claims, onClose }) => {
            const [selectedParticipant, setSelectedParticipant] = useState('');
            const [selectedMonth, setSelectedMonth] = useState('');
            const [copied, setCopied] = useState(false);
            const [emailType, setEmailType] = useState('acknowledgment'); // acknowledgment, monthly-summary

            // Get unique participants with approved claims
            const participants = [...new Set(claims.filter(c => c.status === 'approved').map(c => c.participant))];

            // Get unique months
            const months = [...new Set(claims.map(c => {
                const date = new Date(c.date);
                return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            }))].sort().reverse();

            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

            const formatMonth = (monthKey) => {
                const [year, month] = monthKey.split('-');
                return `${monthNames[parseInt(month) - 1]} ${year}`;
            };

            // Filter claims based on selection
            const getFilteredClaims = () => {
                let filtered = claims.filter(c => c.status === 'approved');
                if (selectedParticipant) {
                    filtered = filtered.filter(c => c.participant === selectedParticipant);
                }
                if (selectedMonth) {
                    filtered = filtered.filter(c => {
                        const date = new Date(c.date);
                        const claimMonth = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                        return claimMonth === selectedMonth;
                    });
                }
                return filtered;
            };

            const filteredClaims = getFilteredClaims();
            const participantData = selectedParticipant ? claims.find(c => c.participant === selectedParticipant) : null;

            // Calculate totals
            const totalAmount = filteredClaims.reduce((sum, c) => sum + c.amount, 0);
            const totalRebate = filteredClaims.reduce((sum, c) => sum + c.rebate, 0);

            // Calculate YTD for participant
            const getYTDRebate = (participant) => {
                return claims
                    .filter(c => c.participant === participant && c.status === 'approved')
                    .reduce((sum, c) => sum + c.rebate, 0);
            };

            const generateAcknowledgmentEmail = () => {
                if (!selectedParticipant || filteredClaims.length === 0) return '';

                const latestClaim = filteredClaims[0];
                const ytdRebate = getYTDRebate(selectedParticipant);
                const yearCap = 500;

                return `Subject: MotorEast EV Charging Rebate - Receipt Acknowledged

Dear ${selectedParticipant},

Thank you for submitting your EV charging receipt. We are pleased to confirm receipt of your claim.

CLAIM DETAILS
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Date:           ${latestClaim.date}
Operator:       ${latestClaim.operator}
Amount Charged: S$${latestClaim.amount.toFixed(2)}
Rebate Rate:    ${(latestClaim.rebateRate * 100).toFixed(0)}%
Rebate Amount:  S$${latestClaim.rebate.toFixed(2)}

YOUR ACCUMULATION
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Year-to-Date Rebate:  S$${ytdRebate.toFixed(2)}
Annual Cap:           S$${yearCap.toFixed(2)}
Remaining Cap:        S$${(yearCap - ytdRebate).toFixed(2)}

Your rebate will be processed and disbursed by the 15th of the following month.

If you have any questions, please don't hesitate to contact us.

Best regards,
MotorEast EV-Ready Condo Program
BYD MotorEast Singapore`;
            };

            const generateMonthlySummaryEmail = () => {
                if (!selectedParticipant || !selectedMonth || filteredClaims.length === 0) return '';

                const ytdRebate = getYTDRebate(selectedParticipant);
                const yearCap = 500;

                let claimsList = filteredClaims.map(c =>
                    `  • ${c.date} | ${c.operator.padEnd(15)} | S$${c.amount.toFixed(2).padStart(7)} | Rebate: S$${c.rebate.toFixed(2)}`
                ).join('\n');

                return `Subject: MotorEast EV Charging Rebate - ${formatMonth(selectedMonth)} Summary

Dear ${selectedParticipant},

Here is your monthly summary for the MotorEast EV-Ready Condo Rebate Program.

${formatMonth(selectedMonth).toUpperCase()} SUMMARY
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Total Claims:        ${filteredClaims.length}
Total Charged:       S$${totalAmount.toFixed(2)}
Total Rebate:        S$${totalRebate.toFixed(2)}

CLAIM BREAKDOWN
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
${claimsList}

YOUR ACCUMULATION
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Year-to-Date Rebate:  S$${ytdRebate.toFixed(2)}
Annual Cap:           S$${yearCap.toFixed(2)}
Remaining Cap:        S$${(yearCap - ytdRebate).toFixed(2)}

Your rebate of S$${totalRebate.toFixed(2)} will be disbursed by the 15th of the following month to your registered bank account.

Thank you for being part of the MotorEast EV-Ready Condo Program!

Best regards,
MotorEast EV-Ready Condo Program
BYD MotorEast Singapore`;
            };

            const emailContent = emailType === 'acknowledgment' ? generateAcknowledgmentEmail() : generateMonthlySummaryEmail();

            const copyToClipboard = () => {
                navigator.clipboard.writeText(emailContent);
                setCopied(true);
                setTimeout(() => setCopied(false), 2000);
            };

            return (
                <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-hidden">
                        <div className="p-6 border-b border-slate-200 flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 bg-blue-100 rounded-xl flex items-center justify-center">
                                    <Mail className="w-5 h-5 text-blue-600" />
                                </div>
                                <div>
                                    <h3 className="text-xl font-bold text-slate-800">Email Template Generator</h3>
                                    <p className="text-sm text-slate-500">Generate acknowledgment emails for customers</p>
                                </div>
                            </div>
                            <button onClick={onClose} className="p-2 hover:bg-slate-100 rounded-lg">
                                <X className="w-5 h-5" />
                            </button>
                        </div>

                        <div className="p-6">
                            {/* Email Type Selection */}
                            <div className="flex gap-2 mb-4">
                                <button
                                    onClick={() => setEmailType('acknowledgment')}
                                    className={`flex-1 py-2 px-4 rounded-lg font-medium transition-all ${emailType === 'acknowledgment' ? 'bg-blue-500 text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}
                                >
                                    Single Receipt Acknowledgment
                                </button>
                                <button
                                    onClick={() => setEmailType('monthly-summary')}
                                    className={`flex-1 py-2 px-4 rounded-lg font-medium transition-all ${emailType === 'monthly-summary' ? 'bg-blue-500 text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}
                                >
                                    Monthly Summary
                                </button>
                            </div>

                            {/* Filters */}
                            <div className="grid sm:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-2">Participant</label>
                                    <select
                                        value={selectedParticipant}
                                        onChange={(e) => setSelectedParticipant(e.target.value)}
                                        className="w-full border border-slate-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none"
                                    >
                                        <option value="">Select participant...</option>
                                        {participants.map(p => (
                                            <option key={p} value={p}>{p}</option>
                                        ))}
                                    </select>
                                </div>
                                {emailType === 'monthly-summary' && (
                                    <div>
                                        <label className="block text-sm font-medium text-slate-700 mb-2">Month</label>
                                        <select
                                            value={selectedMonth}
                                            onChange={(e) => setSelectedMonth(e.target.value)}
                                            className="w-full border border-slate-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none"
                                        >
                                            <option value="">Select month...</option>
                                            {months.map(m => (
                                                <option key={m} value={m}>{formatMonth(m)}</option>
                                            ))}
                                        </select>
                                    </div>
                                )}
                            </div>

                            {/* Preview Stats */}
                            {filteredClaims.length > 0 && (
                                <div className="bg-slate-50 rounded-xl p-4 mb-4 border border-slate-200">
                                    <div className="grid grid-cols-3 gap-4 text-center">
                                        <div>
                                            <p className="text-xs text-slate-500">Claims</p>
                                            <p className="font-bold text-slate-800">{filteredClaims.length}</p>
                                        </div>
                                        <div>
                                            <p className="text-xs text-slate-500">Total Charged</p>
                                            <p className="font-bold text-slate-800">S${totalAmount.toFixed(2)}</p>
                                        </div>
                                        <div>
                                            <p className="text-xs text-slate-500">Total Rebate</p>
                                            <p className="font-bold text-emerald-600">S${totalRebate.toFixed(2)}</p>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Email Preview */}
                            <div className="relative">
                                <label className="block text-sm font-medium text-slate-700 mb-2">Email Preview</label>
                                <textarea
                                    value={emailContent}
                                    readOnly
                                    placeholder="Select a participant to generate email..."
                                    className="w-full h-64 border border-slate-300 rounded-lg px-4 py-3 font-mono text-sm bg-slate-50 resize-none"
                                />
                                {emailContent && (
                                    <button
                                        onClick={copyToClipboard}
                                        className={`absolute top-8 right-2 flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-medium transition-all ${copied ? 'bg-emerald-500 text-white' : 'bg-white border border-slate-300 text-slate-600 hover:bg-slate-50'}`}
                                    >
                                        {copied ? (
                                            <><CheckCircle className="w-4 h-4" />Copied!</>
                                        ) : (
                                            <><Copy className="w-4 h-4" />Copy</>
                                        )}
                                    </button>
                                )}
                            </div>

                            {/* Recipient Email */}
                            {participantData && (
                                <div className="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                                    <p className="text-sm text-blue-800">
                                        <span className="font-medium">Send to:</span> {participantData.email}
                                    </p>
                                </div>
                            )}
                        </div>

                        <div className="p-4 border-t border-slate-200 bg-slate-50 flex justify-end gap-3">
                            <button
                                onClick={onClose}
                                className="px-4 py-2 text-slate-600 hover:bg-slate-200 rounded-lg font-medium"
                            >
                                Close
                            </button>
                            {emailContent && participantData && (
                                <a
                                    href={`mailto:${participantData.email}?subject=${encodeURIComponent(emailContent.split('\n')[0].replace('Subject: ', ''))}&body=${encodeURIComponent(emailContent.split('\n').slice(2).join('\n'))}`}
                                    className="flex items-center gap-2 bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg"
                                >
                                    <Mail className="w-4 h-4" />
                                    Open in Email Client
                                </a>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // Customer Dashboard
        const CustomerDashboard = ({ user, claims, setClaims, onLogout }) => {
            const [showUpload, setShowUpload] = useState(false);
            const [showMonthly, setShowMonthly] = useState(false);
            const [uploadedFile, setUploadedFile] = useState(null);
            const [previewUrl, setPreviewUrl] = useState(null);
            const [formData, setFormData] = useState({ operator: '', amount: '', date: '' });
            const [submitting, setSubmitting] = useState(false);
            const [submitSuccess, setSubmitSuccess] = useState(false);
            const [aiAnalysis, setAiAnalysis] = useState(null); // AI receipt analysis result
            const [analyzing, setAnalyzing] = useState(false);

            // Filter claims by user ID (Supabase) or name (demo mode)
            const userClaims = claims.filter(c => c.userId === user.id || c.participant === user.name);
            const approvedTotal = userClaims.filter(c => c.status === 'approved').reduce((sum, c) => sum + c.rebate, 0);
            const pendingTotal = userClaims.filter(c => c.status === 'pending').reduce((sum, c) => sum + c.rebate, 0);
            const yearCap = 500;

            // Handle case where user has no condo assigned
            const condo = condoData.find(c => c.name === user.condo) || { name: 'Not Assigned', tier: 'Bronze', owners: 0, rate: 0.10 };
            const tierInfo = tierConfig[condo.tier] || tierConfig['Bronze'];
            const ownersToNext = tierInfo.next ? tierInfo.nextMin - condo.owners : 0;

            // Known operators for matching
            const knownOperators = ['Charge+', 'SP Group', 'Shell Recharge', 'CDG Engie', 'Volt', 'BlueSG', 'Greenlots'];

            const handleFileChange = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    setUploadedFile(file);
                    setAiAnalysis(null);

                    // Generate preview for images
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onloadend = () => setPreviewUrl(reader.result);
                        reader.readAsDataURL(file);
                    } else {
                        setPreviewUrl(null);
                    }

                    // Run AI analysis if API key is configured
                    if (GEMINI_API_KEY) {
                        setAnalyzing(true);
                        const result = await analyzeReceipt(file);
                        setAnalyzing(false);

                        if (result.success && result.data) {
                            setAiAnalysis(result.data);

                            // Auto-fill form with AI results
                            const aiData = result.data;
                            setFormData(prev => ({
                                operator: aiData.operator && knownOperators.some(op => aiData.operator.toLowerCase().includes(op.toLowerCase()))
                                    ? knownOperators.find(op => aiData.operator.toLowerCase().includes(op.toLowerCase()))
                                    : aiData.operator || prev.operator,
                                amount: aiData.amount ? String(aiData.amount) : prev.amount,
                                date: aiData.date || prev.date
                            }));
                        } else {
                            setAiAnalysis({ error: result.error });
                        }
                    }
                }
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setSubmitting(true);

                try {
                    if (USE_SUPABASE) {
                        // Save to Supabase with receipt
                        const newClaim = await db.submitClaim(
                            { date: formData.date, operator: formData.operator, amount: parseFloat(formData.amount) },
                            user.id,
                            user.condoId,
                            user.rebateRate || tierInfo.rate,
                            uploadedFile
                        );

                        // Add to local state for immediate display
                        const claimForDisplay = {
                            id: newClaim.id,
                            userId: user.id,
                            date: newClaim.charge_date,
                            operator: newClaim.operator,
                            amount: parseFloat(newClaim.amount),
                            rebateRate: parseFloat(newClaim.rebate_rate),
                            rebate: parseFloat(newClaim.rebate_amount),
                            status: newClaim.status,
                            participant: user.name,
                            condo: user.condo,
                            vehicle: user.vehicle,
                        };
                        setClaims([claimForDisplay, ...claims]);
                    } else {
                        // Demo mode - local state only
                        const rebateAmount = parseFloat(formData.amount) * tierInfo.rate;
                        const newClaim = {
                            id: claims.length + 1,
                            date: formData.date,
                            operator: formData.operator,
                            amount: parseFloat(formData.amount),
                            rebateRate: tierInfo.rate,
                            rebate: rebateAmount,
                            status: parseFloat(formData.amount) > 300 ? 'flagged' : 'pending',
                            participant: user.name,
                            condo: user.condo,
                            vehicle: user.vehicle,
                        };
                        setClaims([newClaim, ...claims]);
                    }

                    setSubmitSuccess(true);
                    setTimeout(() => {
                        setShowUpload(false);
                        setSubmitSuccess(false);
                        setUploadedFile(null);
                        setPreviewUrl(null);
                        setFormData({ operator: '', amount: '', date: '' });
                        setAiAnalysis(null);
                    }, 2000);
                } catch (err) {
                    console.error('Failed to submit claim:', err);
                    alert('Failed to submit claim: ' + err.message);
                }
                setSubmitting(false);
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-slate-50 via-slate-100 to-amber-50">
                    {/* Header */}
                    <header className="bg-gradient-to-r from-slate-900 via-slate-800 to-slate-900 text-white shadow-xl">
                        <div className="max-w-6xl mx-auto px-4 py-4">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <div className="w-10 h-10 bg-gradient-to-br from-amber-400 to-amber-600 rounded-lg flex items-center justify-center shadow-lg">
                                        <Zap className="w-6 h-6 text-white" />
                                    </div>
                                    <div>
                                        <h1 className="text-xl font-bold tracking-tight">MotorEast</h1>
                                        <p className="text-xs text-amber-400 font-medium">EV-Ready Condo Program</p>
                                    </div>
                                </div>
                                <div className="flex items-center gap-4">
                                    <div className="text-right hidden sm:block">
                                        <p className="text-sm font-medium">{user.name}</p>
                                        <p className="text-xs text-slate-400">{user.vehicle}</p>
                                    </div>
                                    <button onClick={onLogout} className="p-2 hover:bg-slate-700 rounded-lg transition-colors">
                                        <LogOut className="w-5 h-5" />
                                    </button>
                                </div>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-6xl mx-auto px-4 py-8">
                        {/* Tier Status Card */}
                        <div className="bg-white rounded-2xl shadow-lg border border-slate-200 p-6 mb-6 overflow-hidden relative">
                            <div className="absolute top-0 right-0 w-64 h-64 bg-gradient-to-bl from-amber-100 to-transparent rounded-bl-full opacity-50" />
                            <div className="relative">
                                <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                                    <div>
                                        <div className="flex items-center gap-3 mb-2">
                                            <TierBadge tier={condo.tier} />
                                            <span className="text-sm text-slate-500">•</span>
                                            <span className="text-sm text-slate-600 font-medium">{condo.name}</span>
                                        </div>
                                        <h2 className="text-2xl font-bold text-slate-800">
                                            {(tierInfo.rate * 100).toFixed(0)}% Charging Rebate
                                        </h2>
                                        <p className="text-slate-500">{tierInfo.duration} year program • Ends Dec 2027</p>
                                    </div>
                                    <div className="flex items-center gap-2 bg-slate-100 rounded-xl px-4 py-3">
                                        <Users className="w-5 h-5 text-amber-600" />
                                        <div>
                                            <p className="text-2xl font-bold text-slate-800">{condo.owners}</p>
                                            <p className="text-xs text-slate-500">MotorEast owners</p>
                                        </div>
                                    </div>
                                </div>
                                
                                {tierInfo.next && (
                                    <div className="bg-gradient-to-r from-amber-50 to-orange-50 rounded-xl p-4 border border-amber-200">
                                        <div className="flex items-center justify-between">
                                            <div className="flex items-center gap-2">
                                                <TrendingUp className="w-5 h-5 text-amber-600" />
                                                <span className="font-medium text-slate-700">
                                                    {ownersToNext} more {ownersToNext === 1 ? 'owner' : 'owners'} to unlock {tierInfo.next}!
                                                </span>
                                            </div>
                                            <span className="text-amber-600 font-bold">{(tierConfig[tierInfo.next].rate * 100).toFixed(0)}% rebate</span>
                                        </div>
                                        <div className="mt-2 h-2 bg-amber-200 rounded-full overflow-hidden">
                                            <div 
                                                className="h-full bg-gradient-to-r from-amber-500 to-orange-500 rounded-full"
                                                style={{ width: `${((condo.owners - tierInfo.min) / (tierInfo.nextMin - tierInfo.min)) * 100}%` }}
                                            />
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Stats Grid */}
                        <div className="grid md:grid-cols-3 gap-4 mb-6">
                            <div className="bg-white rounded-xl shadow-md border border-slate-200 p-5">
                                <div className="flex items-center justify-between mb-3">
                                    <span className="text-slate-500 text-sm font-medium">2024 Rebate Cap</span>
                                    <DollarSign className="w-5 h-5 text-emerald-500" />
                                </div>
                                <ProgressBar current={approvedTotal} max={yearCap} />
                            </div>
                            
                            <div className="bg-white rounded-xl shadow-md border border-slate-200 p-5">
                                <div className="flex items-center justify-between mb-3">
                                    <span className="text-slate-500 text-sm font-medium">Total Claimed</span>
                                    <CheckCircle className="w-5 h-5 text-emerald-500" />
                                </div>
                                <p className="text-3xl font-bold text-slate-800">${approvedTotal.toFixed(2)}</p>
                                <p className="text-sm text-slate-500">{userClaims.filter(c => c.status === 'approved').length} approved claims</p>
                            </div>
                            
                            <div className="bg-white rounded-xl shadow-md border border-slate-200 p-5">
                                <div className="flex items-center justify-between mb-3">
                                    <span className="text-slate-500 text-sm font-medium">Pending</span>
                                    <Clock className="w-5 h-5 text-amber-500" />
                                </div>
                                <p className="text-3xl font-bold text-slate-800">${pendingTotal.toFixed(2)}</p>
                                <p className="text-sm text-slate-500">{userClaims.filter(c => c.status === 'pending').length} pending review</p>
                            </div>
                        </div>

                        {/* Action Buttons */}
                        <div className="grid sm:grid-cols-2 gap-4 mb-6">
                            <button
                                onClick={() => setShowUpload(true)}
                                className="bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 text-white font-bold py-4 px-6 rounded-xl shadow-lg hover:shadow-xl transition-all flex items-center justify-center gap-3"
                            >
                                <Upload className="w-5 h-5" />
                                Submit New Claim
                            </button>
                            <button
                                onClick={() => setShowMonthly(true)}
                                className="bg-white border-2 border-amber-500 text-amber-600 hover:bg-amber-50 font-bold py-4 px-6 rounded-xl shadow-md hover:shadow-lg transition-all flex items-center justify-center gap-3"
                            >
                                <BarChart className="w-5 h-5" />
                                Monthly Summary
                            </button>
                        </div>

                        {/* Upload Modal */}
                        {showUpload && (
                            <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                                <div className="bg-white rounded-2xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
                                    <div className="p-6 border-b border-slate-200">
                                        <div className="flex items-center justify-between">
                                            <h3 className="text-xl font-bold text-slate-800">Submit Charging Receipt</h3>
                                            <button onClick={() => { setShowUpload(false); setUploadedFile(null); setPreviewUrl(null); setFormData({ operator: '', amount: '', date: '' }); setAiAnalysis(null); }} className="p-2 hover:bg-slate-100 rounded-lg">
                                                <X className="w-5 h-5" />
                                            </button>
                                        </div>
                                    </div>
                                    
                                    {submitSuccess ? (
                                        <div className="p-12 text-center">
                                            <div className="w-16 h-16 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                                <CheckCircle className="w-8 h-8 text-emerald-600" />
                                            </div>
                                            <h4 className="text-xl font-bold text-slate-800 mb-2">Claim Submitted!</h4>
                                            <p className="text-slate-500">Your rebate will be processed by the 15th of next month.</p>
                                        </div>
                                    ) : (
                                        <form onSubmit={handleSubmit} className="p-6 space-y-6">
                                            {/* File Upload */}
                                            <div className={`border-2 border-dashed rounded-xl p-8 text-center transition-colors ${uploadedFile ? 'border-emerald-300 bg-emerald-50' : 'border-slate-300 hover:border-amber-400'}`}>
                                                {uploadedFile ? (
                                                    <div>
                                                        {uploadedFile.type === 'application/pdf' ? (
                                                            <div className="w-24 h-24 mx-auto mb-4 bg-red-100 rounded-lg flex items-center justify-center">
                                                                <FileText className="w-12 h-12 text-red-500" />
                                                            </div>
                                                        ) : (
                                                            <img src={previewUrl} alt="Receipt" className="max-h-48 mx-auto rounded-lg shadow-md mb-4" />
                                                        )}
                                                        <p className="text-sm text-emerald-600 font-medium">{uploadedFile?.name}</p>
                                                        <button type="button" onClick={() => { setUploadedFile(null); setPreviewUrl(null); }} className="text-sm text-slate-500 hover:text-red-500 mt-2">Remove</button>
                                                    </div>
                                                ) : (
                                                    <div>
                                                        <Upload className="w-12 h-12 text-slate-400 mx-auto mb-4" />
                                                        <p className="text-slate-600 font-medium mb-2">Upload your receipt</p>
                                                        <p className="text-slate-400 text-sm mb-3">Images or PDF</p>
                                                        <input type="file" accept="image/*,.pdf,application/pdf" onChange={handleFileChange} className="hidden" id="file-upload" />
                                                        <label htmlFor="file-upload" className="inline-block bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium py-2 px-4 rounded-lg cursor-pointer">Browse Files</label>
                                                    </div>
                                                )}
                                            </div>

                                            {/* AI Analysis Status */}
                                            {analyzing && (
                                                <div className="bg-blue-50 border border-blue-200 rounded-xl p-4">
                                                    <div className="flex items-center gap-3">
                                                        <div className="w-5 h-5 border-2 border-blue-500 border-t-transparent rounded-full animate-spin" />
                                                        <span className="text-blue-700 font-medium">Analyzing receipt with AI...</span>
                                                    </div>
                                                </div>
                                            )}

                                            {aiAnalysis && !analyzing && (
                                                <div className={`rounded-xl p-4 border ${aiAnalysis.error ? 'bg-red-50 border-red-200' : aiAnalysis.isEVCharging ? 'bg-emerald-50 border-emerald-200' : 'bg-orange-50 border-orange-200'}`}>
                                                    {aiAnalysis.error ? (
                                                        <div className="flex items-center gap-2 text-red-700">
                                                            <AlertTriangle className="w-5 h-5" />
                                                            <span>AI analysis failed: {aiAnalysis.error}</span>
                                                        </div>
                                                    ) : aiAnalysis.isEVCharging ? (
                                                        <div>
                                                            <div className="flex items-center gap-2 text-emerald-700 font-medium mb-2">
                                                                <CheckCircle className="w-5 h-5" />
                                                                <span>EV Charging Receipt Verified</span>
                                                                <span className={`text-xs px-2 py-0.5 rounded-full ${aiAnalysis.confidence === 'high' ? 'bg-emerald-200' : aiAnalysis.confidence === 'medium' ? 'bg-amber-200 text-amber-700' : 'bg-slate-200 text-slate-600'}`}>
                                                                    {aiAnalysis.confidence} confidence
                                                                </span>
                                                            </div>
                                                            <p className="text-sm text-emerald-600">{aiAnalysis.reason}</p>
                                                            {aiAnalysis.location && <p className="text-xs text-slate-500 mt-1">Location: {aiAnalysis.location}</p>}
                                                        </div>
                                                    ) : (
                                                        <div>
                                                            <div className="flex items-center gap-2 text-orange-700 font-medium mb-2">
                                                                <AlertTriangle className="w-5 h-5" />
                                                                <span>Not an EV Charging Receipt</span>
                                                            </div>
                                                            <p className="text-sm text-orange-600">{aiAnalysis.reason}</p>
                                                        </div>
                                                    )}
                                                </div>
                                            )}

                                            {/* Form Fields */}
                                            <div className="grid gap-4">
                                                <div>
                                                    <label className="block text-sm font-medium text-slate-700 mb-2">Charging Operator {aiAnalysis?.operator && <span className="text-emerald-500 text-xs">(AI detected)</span>}</label>
                                                    <select value={formData.operator} onChange={(e) => setFormData({ ...formData, operator: e.target.value })} required className="w-full border border-slate-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-amber-500 outline-none">
                                                        <option value="">Select operator...</option>
                                                        <option value="Charge+">Charge+</option>
                                                        <option value="SP Group">SP Group</option>
                                                        <option value="Shell Recharge">Shell Recharge</option>
                                                        <option value="CDG Engie">CDG Engie</option>
                                                        <option value="Volt">Volt</option>
                                                        <option value="BlueSG">BlueSG</option>
                                                        <option value="Greenlots">Greenlots</option>
                                                        <option value="Other">Other</option>
                                                    </select>
                                                </div>
                                                <div className="grid grid-cols-2 gap-4">
                                                    <div>
                                                        <label className="block text-sm font-medium text-slate-700 mb-2">Amount (S$) {aiAnalysis?.amount && <span className="text-emerald-500 text-xs">(AI detected)</span>}</label>
                                                        <input type="number" step="0.01" value={formData.amount} onChange={(e) => setFormData({ ...formData, amount: e.target.value })} required placeholder="0.00" className="w-full border border-slate-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-amber-500 outline-none" />
                                                    </div>
                                                    <div>
                                                        <label className="block text-sm font-medium text-slate-700 mb-2">Charge Date {aiAnalysis?.date && <span className="text-emerald-500 text-xs">(AI detected)</span>}</label>
                                                        <input type="date" value={formData.date} onChange={(e) => setFormData({ ...formData, date: e.target.value })} required className="w-full border border-slate-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-amber-500 outline-none" />
                                                    </div>
                                                </div>
                                            </div>

                                            {formData.amount && (
                                                <div className="bg-amber-50 rounded-xl p-4 border border-amber-200">
                                                    <div className="flex items-center justify-between">
                                                        <span className="text-slate-600">Estimated Rebate ({(tierInfo.rate * 100).toFixed(0)}%)</span>
                                                        <span className="text-xl font-bold text-amber-600">${(parseFloat(formData.amount || 0) * tierInfo.rate).toFixed(2)}</span>
                                                    </div>
                                                </div>
                                            )}

                                            {/* Warning if AI says not EV receipt */}
                                            {aiAnalysis && !aiAnalysis.error && !aiAnalysis.isEVCharging && (
                                                <div className="bg-orange-100 border border-orange-300 rounded-xl p-4 text-center">
                                                    <p className="text-orange-700 font-medium">This receipt may not qualify for EV charging rebate</p>
                                                    <p className="text-orange-600 text-sm mt-1">Please ensure you're submitting a valid EV charging receipt</p>
                                                </div>
                                            )}

                                            <button type="submit" disabled={!uploadedFile || !formData.operator || !formData.amount || !formData.date || submitting || analyzing || (GEMINI_API_KEY && aiAnalysis && !aiAnalysis.isEVCharging)} className="w-full bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 disabled:from-slate-300 disabled:to-slate-400 text-white font-bold py-4 px-6 rounded-xl shadow-lg transition-all flex items-center justify-center gap-2">
                                                {submitting ? (
                                                    <><div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin" />Processing...</>
                                                ) : analyzing ? (
                                                    <><div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin" />Analyzing...</>
                                                ) : (
                                                    <><Upload className="w-5 h-5" />Submit Claim</>
                                                )}
                                            </button>
                                        </form>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* Monthly Accumulation Modal */}
                        {showMonthly && (
                            <MonthlyAccumulation claims={userClaims} onClose={() => setShowMonthly(false)} />
                        )}

                        {/* Recent Claims */}
                        <div className="bg-white rounded-2xl shadow-lg border border-slate-200 overflow-hidden">
                            <div className="p-6 border-b border-slate-200">
                                <h3 className="text-lg font-bold text-slate-800">Recent Claims</h3>
                            </div>
                            <div className="divide-y divide-slate-100">
                                {userClaims.length === 0 ? (
                                    <div className="p-12 text-center">
                                        <FileText className="w-12 h-12 text-slate-300 mx-auto mb-4" />
                                        <p className="text-slate-500">No claims yet. Submit your first charging receipt!</p>
                                    </div>
                                ) : (
                                    userClaims.map(claim => (
                                        <div key={claim.id} className="p-4 hover:bg-slate-50 transition-colors">
                                            <div className="flex items-center justify-between">
                                                <div className="flex items-center gap-4">
                                                    <div className="w-12 h-12 bg-slate-100 rounded-xl flex items-center justify-center">
                                                        <Zap className="w-6 h-6 text-amber-500" />
                                                    </div>
                                                    <div>
                                                        <p className="font-medium text-slate-800">{claim.operator}</p>
                                                        <p className="text-sm text-slate-500">{claim.date}</p>
                                                    </div>
                                                </div>
                                                <div className="text-right">
                                                    <p className="font-bold text-slate-800">${claim.amount.toFixed(2)}</p>
                                                    <div className="flex items-center gap-2 justify-end">
                                                        <span className="text-sm text-emerald-600 font-medium">+${claim.rebate.toFixed(2)}</span>
                                                        <StatusBadge status={claim.status} />
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>
                    </main>
                </div>
            );
        };

        // Admin Dashboard
        const AdminDashboard = ({ claims, setClaims, onLogout }) => {
            const [filter, setFilter] = useState('all');
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedClaim, setSelectedClaim] = useState(null);
            const [showEmailGenerator, setShowEmailGenerator] = useState(false);

            const filteredClaims = claims.filter(claim => {
                const matchesFilter = filter === 'all' || claim.status === filter;
                const matchesSearch = (claim.participant || '').toLowerCase().includes(searchTerm.toLowerCase()) || (claim.condo || '').toLowerCase().includes(searchTerm.toLowerCase());
                return matchesFilter && matchesSearch;
            });

            const pendingCount = claims.filter(c => c.status === 'pending').length;
            const flaggedCount = claims.filter(c => c.status === 'flagged').length;
            const readyForPayout = claims.filter(c => c.status === 'approved');
            const payoutTotal = readyForPayout.reduce((sum, c) => sum + c.rebate, 0);

            const handleApprove = async (id) => {
                try {
                    if (USE_SUPABASE) {
                        await db.updateClaimStatus(id, 'approved', null);
                    }
                    setClaims(claims.map(c => c.id === id ? { ...c, status: 'approved' } : c));
                    setSelectedClaim(null);
                } catch (err) {
                    console.error('Failed to approve claim:', err);
                    alert('Failed to approve claim: ' + err.message);
                }
            };

            const handleReject = async (id) => {
                try {
                    if (USE_SUPABASE) {
                        await db.updateClaimStatus(id, 'rejected', null);
                    }
                    setClaims(claims.map(c => c.id === id ? { ...c, status: 'rejected' } : c));
                    setSelectedClaim(null);
                } catch (err) {
                    console.error('Failed to reject claim:', err);
                    alert('Failed to reject claim: ' + err.message);
                }
            };

            const downloadCSV = () => {
                const approvedClaims = claims.filter(c => c.status === 'approved');
                const headers = ['Participant', 'Condo', 'Vehicle', 'Date', 'Operator', 'Amount', 'Rebate Rate', 'Rebate Amount'];
                const rows = approvedClaims.map(c => [c.participant || '', c.condo || '', c.vehicle || '', c.date || '', c.operator || '', (c.amount || 0).toFixed(2), ((c.rebateRate || 0) * 100).toFixed(0) + '%', (c.rebate || 0).toFixed(2)]);
                const csvContent = [headers.join(','), ...rows.map(row => row.join(','))].join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `motoreast-rebates-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
            };

            return (
                <div className="min-h-screen bg-slate-100">
                    <header className="bg-gradient-to-r from-slate-900 via-slate-800 to-slate-900 text-white shadow-xl">
                        <div className="max-w-7xl mx-auto px-4 py-4">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <div className="w-10 h-10 bg-gradient-to-br from-amber-400 to-amber-600 rounded-lg flex items-center justify-center">
                                        <Zap className="w-6 h-6 text-white" />
                                    </div>
                                    <div>
                                        <h1 className="text-xl font-bold">MotorEast Admin</h1>
                                        <p className="text-xs text-amber-400 font-medium">Rebate Management Portal</p>
                                    </div>
                                </div>
                                <button onClick={onLogout} className="flex items-center gap-2 px-4 py-2 hover:bg-slate-700 rounded-lg">
                                    <LogOut className="w-5 h-5" /><span className="hidden sm:inline">Logout</span>
                                </button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto px-4 py-8">
                        {/* Stats */}
                        <div className="grid sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                            <div className="bg-white rounded-xl shadow-md p-5 border-l-4 border-amber-500">
                                <p className="text-sm text-slate-500">Pending Review</p>
                                <p className="text-3xl font-bold text-slate-800">{pendingCount}</p>
                            </div>
                            <div className="bg-white rounded-xl shadow-md p-5 border-l-4 border-orange-500">
                                <p className="text-sm text-slate-500">Flagged</p>
                                <p className="text-3xl font-bold text-slate-800">{flaggedCount}</p>
                            </div>
                            <div className="bg-white rounded-xl shadow-md p-5 border-l-4 border-emerald-500">
                                <p className="text-sm text-slate-500">Ready for Payout</p>
                                <p className="text-3xl font-bold text-slate-800">{readyForPayout.length}</p>
                            </div>
                            <div className="bg-white rounded-xl shadow-md p-5 border-l-4 border-blue-500">
                                <p className="text-sm text-slate-500">Payout Amount</p>
                                <p className="text-3xl font-bold text-slate-800">${payoutTotal.toFixed(2)}</p>
                            </div>
                        </div>

                        {/* Condo Summary */}
                        <div className="bg-white rounded-xl shadow-md mb-6 overflow-hidden">
                            <div className="p-5 border-b border-slate-200">
                                <h3 className="text-lg font-bold text-slate-800">Condo Summary</h3>
                            </div>
                            <table className="w-full">
                                <thead className="bg-slate-50">
                                    <tr>
                                        <th className="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase">Condo</th>
                                        <th className="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase">Owners</th>
                                        <th className="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase">Tier</th>
                                        <th className="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase">Monthly Claims</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100">
                                    {condoData.map((condo, idx) => (
                                        <tr key={idx} className="hover:bg-slate-50">
                                            <td className="px-6 py-4 font-medium text-slate-800">{condo.name}</td>
                                            <td className="px-6 py-4 text-slate-600">{condo.owners}</td>
                                            <td className="px-6 py-4"><TierBadge tier={condo.tier} /></td>
                                            <td className="px-6 py-4 text-slate-600">${condo.monthlyCharging}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>

                        {/* Claims Table */}
                        <div className="bg-white rounded-xl shadow-md overflow-hidden">
                            <div className="p-5 border-b border-slate-200">
                                <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                                    <h3 className="text-lg font-bold text-slate-800">All Claims</h3>
                                    <div className="flex flex-col sm:flex-row gap-3">
                                        <div className="relative">
                                            <Search className="w-5 h-5 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2" />
                                            <input type="text" placeholder="Search..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="pl-10 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none w-full sm:w-48" />
                                        </div>
                                        <select value={filter} onChange={(e) => setFilter(e.target.value)} className="border border-slate-300 rounded-lg px-4 py-2">
                                            <option value="all">All Status</option>
                                            <option value="pending">Pending</option>
                                            <option value="flagged">Flagged</option>
                                            <option value="approved">Approved</option>
                                            <option value="rejected">Rejected</option>
                                        </select>
                                        <button onClick={() => setShowEmailGenerator(true)} className="flex items-center gap-2 bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg">
                                            <Mail className="w-5 h-5" />Email
                                        </button>
                                        <button onClick={downloadCSV} className="flex items-center gap-2 bg-emerald-500 hover:bg-emerald-600 text-white font-medium py-2 px-4 rounded-lg">
                                            <Download className="w-5 h-5" />Export CSV
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div className="overflow-x-auto">
                                <table className="w-full">
                                    <thead className="bg-slate-50">
                                        <tr>
                                            <th className="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase">Date</th>
                                            <th className="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase">Participant</th>
                                            <th className="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase">Condo</th>
                                            <th className="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase">Amount</th>
                                            <th className="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase">Rebate</th>
                                            <th className="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase">Status</th>
                                            <th className="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100">
                                        {filteredClaims.map(claim => (
                                            <tr key={claim.id} className="hover:bg-slate-50">
                                                <td className="px-4 py-4 text-sm text-slate-600">{claim.date}</td>
                                                <td className="px-4 py-4">
                                                    <p className="font-medium text-slate-800">{claim.participant}</p>
                                                    <p className="text-xs text-slate-500">{claim.vehicle}</p>
                                                </td>
                                                <td className="px-4 py-4 text-sm text-slate-600">{claim.condo}</td>
                                                <td className="px-4 py-4 text-sm font-medium text-slate-800">${claim.amount.toFixed(2)}</td>
                                                <td className="px-4 py-4 text-sm font-medium text-emerald-600">${claim.rebate.toFixed(2)}</td>
                                                <td className="px-4 py-4"><StatusBadge status={claim.status} /></td>
                                                <td className="px-4 py-4">
                                                    <div className="flex items-center gap-2">
                                                        {claim.receiptPath && (
                                                            <button onClick={() => setSelectedClaim(claim)} className="p-2 text-blue-600 hover:bg-blue-50 rounded-lg" title="View Receipt">
                                                                <Eye className="w-4 h-4" />
                                                            </button>
                                                        )}
                                                        {(claim.status === 'pending' || claim.status === 'flagged') && (
                                                            <>
                                                                <button onClick={() => handleApprove(claim.id)} className="p-2 text-emerald-600 hover:bg-emerald-50 rounded-lg" title="Approve">
                                                                    <CheckCircle className="w-4 h-4" />
                                                                </button>
                                                                <button onClick={() => handleReject(claim.id)} className="p-2 text-red-600 hover:bg-red-50 rounded-lg" title="Reject">
                                                                    <XCircle className="w-4 h-4" />
                                                                </button>
                                                            </>
                                                        )}
                                                    </div>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        {/* Email Generator Modal */}
                        {showEmailGenerator && (
                            <EmailTemplateGenerator claims={claims} onClose={() => setShowEmailGenerator(false)} />
                        )}

                        {/* Receipt Viewer Modal */}
                        {selectedClaim && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                                <div className="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-hidden">
                                    <div className="p-6 border-b border-slate-200 flex items-center justify-between">
                                        <h3 className="text-xl font-bold text-slate-800">Claim Details</h3>
                                        <button onClick={() => setSelectedClaim(null)} className="p-2 hover:bg-slate-100 rounded-lg">
                                            <X className="w-5 h-5 text-slate-500" />
                                        </button>
                                    </div>
                                    <div className="p-6 overflow-y-auto max-h-[70vh]">
                                        <div className="grid grid-cols-2 gap-4 mb-6">
                                            <div><span className="text-slate-500 text-sm">Participant</span><p className="font-medium">{selectedClaim.participant || 'N/A'}</p></div>
                                            <div><span className="text-slate-500 text-sm">Email</span><p className="font-medium">{selectedClaim.email || 'N/A'}</p></div>
                                            <div><span className="text-slate-500 text-sm">Condo</span><p className="font-medium">{selectedClaim.condo || 'N/A'}</p></div>
                                            <div><span className="text-slate-500 text-sm">Vehicle</span><p className="font-medium">{selectedClaim.vehicle || 'N/A'}</p></div>
                                            <div><span className="text-slate-500 text-sm">Date</span><p className="font-medium">{selectedClaim.date}</p></div>
                                            <div><span className="text-slate-500 text-sm">Operator</span><p className="font-medium">{selectedClaim.operator}</p></div>
                                            <div><span className="text-slate-500 text-sm">Amount</span><p className="font-medium">${selectedClaim.amount.toFixed(2)}</p></div>
                                            <div><span className="text-slate-500 text-sm">Rebate ({(selectedClaim.rebateRate * 100).toFixed(0)}%)</span><p className="font-medium text-emerald-600">${selectedClaim.rebate.toFixed(2)}</p></div>
                                        </div>
                                        {selectedClaim.receiptPath && (
                                            <div className="border-t border-slate-200 pt-6">
                                                <h4 className="font-semibold text-slate-800 mb-4">Receipt</h4>
                                                {selectedClaim.receiptPath.toLowerCase().endsWith('.pdf') ? (
                                                    <a
                                                        href={`${SUPABASE_URL}/storage/v1/object/public/receipts/${selectedClaim.receiptPath}`}
                                                        target="_blank"
                                                        rel="noopener noreferrer"
                                                        className="inline-flex items-center gap-2 bg-red-100 hover:bg-red-200 text-red-700 font-medium py-3 px-6 rounded-lg"
                                                    >
                                                        <FileText className="w-5 h-5" />
                                                        View PDF Receipt
                                                    </a>
                                                ) : (
                                                    <>
                                                        <img
                                                            src={`${SUPABASE_URL}/storage/v1/object/public/receipts/${selectedClaim.receiptPath}`}
                                                            alt="Receipt"
                                                            className="max-w-full rounded-lg shadow-md border"
                                                            onError={(e) => { e.target.style.display = 'none'; e.target.nextSibling.style.display = 'block'; }}
                                                        />
                                                        <p className="text-slate-500 text-sm hidden">Receipt image could not be loaded</p>
                                                    </>
                                                )}
                                            </div>
                                        )}
                                        <div className="flex gap-3 mt-6 pt-6 border-t border-slate-200">
                                            {(selectedClaim.status === 'pending' || selectedClaim.status === 'flagged') && (
                                                <>
                                                    <button onClick={() => { handleApprove(selectedClaim.id); setSelectedClaim(null); }} className="flex-1 bg-emerald-500 hover:bg-emerald-600 text-white font-medium py-3 rounded-lg">Approve</button>
                                                    <button onClick={() => { handleReject(selectedClaim.id); setSelectedClaim(null); }} className="flex-1 bg-red-500 hover:bg-red-600 text-white font-medium py-3 rounded-lg">Reject</button>
                                                </>
                                            )}
                                            <button onClick={() => setSelectedClaim(null)} className="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-700 font-medium py-3 rounded-lg">Close</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        // Login Screen with Registration
        const LoginScreen = ({ onLogin, setClaims }) => {
            const [mode, setMode] = useState('customer'); // customer, admin
            const [view, setView] = useState('login'); // login, register
            const [loginData, setLoginData] = useState({ email: '', password: '' });
            const [registerData, setRegisterData] = useState({ name: '', email: '', password: '', confirmPassword: '', vehicle: '', condo: '' });
            const [condosList, setCondosList] = useState([]);
            const [showPassword, setShowPassword] = useState(false);
            const [error, setError] = useState('');
            const [success, setSuccess] = useState('');
            const [isLoading, setIsLoading] = useState(false);

            // Load condos list for registration
            useEffect(() => {
                if (USE_SUPABASE) {
                    db.getCondos().then(setCondosList).catch(console.error);
                }
            }, []);

            // Demo users database (fallback when USE_SUPABASE is false)
            const demoUsers = {
                'john.tan@email.com': { password: 'demo123', type: 'customer', name: 'John Tan', vehicle: 'SMA1234B', condo: 'The Reef @ KPE' },
                'david.wong@email.com': { password: 'demo123', type: 'customer', name: 'David Wong', vehicle: 'SMC9012D', condo: 'Parc Esta' },
                'admin@motoreast.sg': { password: 'admin123', type: 'admin' }
            };

            const handleLogin = async (e) => {
                e.preventDefault();
                setError('');
                setIsLoading(true);

                try {
                    if (USE_SUPABASE) {
                        // Supabase authentication
                        const { user: authUser } = await db.signIn(loginData.email, loginData.password);
                        const profile = await db.getProfile(authUser.id);

                        // Check role matches login mode
                        if (mode === 'admin' && profile.role !== 'admin') {
                            setError('This account is not an admin account.');
                            await db.signOut();
                            setIsLoading(false);
                            return;
                        }

                        const userData = {
                            id: authUser.id,
                            type: profile.role,
                            name: profile.name,
                            email: profile.email,
                            vehicle: profile.vehicle_number,
                            condo: profile.condo?.name || '',
                            condoId: profile.condo_id,
                            rebateRate: profile.condo?.rebate_rate || 0.10
                        };

                        // Load claims for admin
                        if (profile.role === 'admin') {
                            const allClaims = await db.getAllClaims();
                            setClaims(allClaims);
                        }

                        onLogin(userData);
                    } else {
                        // Demo mode
                        const user = demoUsers[loginData.email.toLowerCase()];
                        if (!user) {
                            setError('Email not found. Please register or check your email.');
                            setIsLoading(false);
                            return;
                        }
                        if (user.password !== loginData.password) {
                            setError('Incorrect password. Please try again.');
                            setIsLoading(false);
                            return;
                        }
                        if (mode === 'admin' && user.type !== 'admin') {
                            setError('This account is not an admin account.');
                            setIsLoading(false);
                            return;
                        }
                        if (mode === 'customer' && user.type === 'admin') {
                            setError('Please use Admin login for this account.');
                            setIsLoading(false);
                            return;
                        }
                        onLogin(user);
                    }
                } catch (err) {
                    console.error('Login error:', err);
                    setError(err.message || 'Login failed. Please check your credentials.');
                }
                setIsLoading(false);
            };

            const handleRegister = async (e) => {
                e.preventDefault();
                setError('');

                if (registerData.password !== registerData.confirmPassword) {
                    setError('Passwords do not match.');
                    return;
                }
                if (registerData.password.length < 6) {
                    setError('Password must be at least 6 characters.');
                    return;
                }

                setIsLoading(true);

                try {
                    if (USE_SUPABASE) {
                        // Find condo ID
                        const selectedCondo = condosList.find(c => c.name === registerData.condo);

                        await db.signUp(registerData.email, registerData.password, {
                            name: registerData.name,
                            vehicle_number: registerData.vehicle,
                            condo_id: selectedCondo?.id
                        });

                        // Update profile with condo_id (trigger creates basic profile)
                        setSuccess('Registration successful! Please check your email to confirm your account, then login.');
                    } else {
                        if (demoUsers[registerData.email.toLowerCase()]) {
                            setError('Email already registered. Please login.');
                            setIsLoading(false);
                            return;
                        }
                        setSuccess('Registration successful! Your account is pending admin approval. You will receive an email once approved.');
                    }

                    setTimeout(() => {
                        setView('login');
                        setSuccess('');
                        setRegisterData({ name: '', email: '', password: '', confirmPassword: '', vehicle: '', condo: '' });
                    }, 3000);
                } catch (err) {
                    console.error('Registration error:', err);
                    setError(err.message || 'Registration failed. Please try again.');
                }
                setIsLoading(false);
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 flex items-center justify-center p-4">
                    <div className="absolute inset-0 overflow-hidden">
                        <div className="absolute top-1/4 left-1/4 w-96 h-96 bg-amber-500/10 rounded-full blur-3xl" />
                        <div className="absolute bottom-1/4 right-1/4 w-96 h-96 bg-orange-500/10 rounded-full blur-3xl" />
                    </div>

                    <div className="relative bg-white/10 backdrop-blur-xl rounded-3xl shadow-2xl border border-white/20 p-8 max-w-md w-full">
                        <div className="text-center mb-6">
                            <div className="w-16 h-16 bg-gradient-to-br from-amber-400 to-amber-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg">
                                <Zap className="w-8 h-8 text-white" />
                            </div>
                            <h1 className="text-3xl font-bold text-white mb-2">MotorEast</h1>
                            <p className="text-amber-400 font-medium">EV-Ready Condo Rebate Portal</p>
                        </div>

                        {/* Mode Toggle */}
                        <div className="flex bg-white/10 rounded-xl p-1 mb-6">
                            <button onClick={() => { setMode('customer'); setView('login'); setError(''); }} className={`flex-1 py-2 px-4 rounded-lg font-medium transition-all ${mode === 'customer' ? 'bg-amber-500 text-white shadow-lg' : 'text-white/70 hover:text-white'}`}>Customer</button>
                            <button onClick={() => { setMode('admin'); setView('login'); setError(''); }} className={`flex-1 py-2 px-4 rounded-lg font-medium transition-all ${mode === 'admin' ? 'bg-amber-500 text-white shadow-lg' : 'text-white/70 hover:text-white'}`}>Admin</button>
                        </div>

                        {/* Error/Success Messages */}
                        {error && (
                            <div className="bg-red-500/20 border border-red-500/50 rounded-lg p-3 mb-4">
                                <p className="text-red-200 text-sm">{error}</p>
                            </div>
                        )}
                        {success && (
                            <div className="bg-emerald-500/20 border border-emerald-500/50 rounded-lg p-3 mb-4">
                                <p className="text-emerald-200 text-sm">{success}</p>
                            </div>
                        )}

                        {view === 'login' ? (
                            <form onSubmit={handleLogin} className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-white/70 mb-2">Email</label>
                                    <input
                                        type="email"
                                        value={loginData.email}
                                        onChange={(e) => setLoginData({ ...loginData, email: e.target.value })}
                                        required
                                        placeholder={mode === 'admin' ? 'admin@motoreast.sg' : 'your@email.com'}
                                        className="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white placeholder-white/40 focus:ring-2 focus:ring-amber-500 outline-none"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-white/70 mb-2">Password</label>
                                    <div className="relative">
                                        <input
                                            type={showPassword ? 'text' : 'password'}
                                            value={loginData.password}
                                            onChange={(e) => setLoginData({ ...loginData, password: e.target.value })}
                                            required
                                            placeholder="••••••••"
                                            className="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white placeholder-white/40 focus:ring-2 focus:ring-amber-500 outline-none pr-12"
                                        />
                                        <button type="button" onClick={() => setShowPassword(!showPassword)} className="absolute right-3 top-1/2 -translate-y-1/2 text-white/40 hover:text-white">
                                            <Eye className="w-5 h-5" />
                                        </button>
                                    </div>
                                </div>
                                <button type="submit" disabled={isLoading} className="w-full bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 disabled:from-slate-500 disabled:to-slate-600 text-white font-bold py-4 px-6 rounded-xl shadow-lg transition-all flex items-center justify-center gap-2">
                                    {isLoading ? (
                                        <><div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin" />Signing in...</>
                                    ) : (
                                        mode === 'admin' ? 'Login as Admin' : 'Login'
                                    )}
                                </button>

                                {mode === 'customer' && (
                                    <div className="text-center pt-4 border-t border-white/10">
                                        <p className="text-white/50 text-sm mb-3">New to MotorEast EV Program?</p>
                                        <button type="button" onClick={() => { setView('register'); setError(''); }} className="flex items-center justify-center gap-2 w-full bg-white/10 hover:bg-white/20 border border-white/20 rounded-xl py-3 px-4 text-white font-medium transition-all">
                                            <UserPlus className="w-5 h-5" />
                                            Register for Rebate Program
                                        </button>
                                    </div>
                                )}

                                {/* Demo credentials hint */}
                                <div className="mt-4 p-3 bg-white/5 rounded-lg border border-white/10">
                                    <p className="text-white/40 text-xs text-center mb-2">Demo Credentials:</p>
                                    {mode === 'customer' ? (
                                        <p className="text-white/60 text-xs text-center">john.tan@email.com / demo123</p>
                                    ) : (
                                        <p className="text-white/60 text-xs text-center">admin@motoreast.sg / admin123</p>
                                    )}
                                </div>
                            </form>
                        ) : (
                            <form onSubmit={handleRegister} className="space-y-4">
                                <div className="flex items-center gap-2 mb-4">
                                    <button type="button" onClick={() => { setView('login'); setError(''); }} className="p-2 hover:bg-white/10 rounded-lg text-white/60 hover:text-white">
                                        <ChevronRight className="w-5 h-5 rotate-180" />
                                    </button>
                                    <h2 className="text-lg font-bold text-white">Register for Rebate Program</h2>
                                </div>

                                <div className="grid grid-cols-2 gap-4">
                                    <div className="col-span-2">
                                        <label className="block text-sm font-medium text-white/70 mb-2">Full Name</label>
                                        <input
                                            type="text"
                                            value={registerData.name}
                                            onChange={(e) => setRegisterData({ ...registerData, name: e.target.value })}
                                            required
                                            placeholder="John Tan"
                                            className="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white placeholder-white/40 focus:ring-2 focus:ring-amber-500 outline-none"
                                        />
                                    </div>
                                    <div className="col-span-2">
                                        <label className="block text-sm font-medium text-white/70 mb-2">Email</label>
                                        <input
                                            type="email"
                                            value={registerData.email}
                                            onChange={(e) => setRegisterData({ ...registerData, email: e.target.value })}
                                            required
                                            placeholder="your@email.com"
                                            className="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white placeholder-white/40 focus:ring-2 focus:ring-amber-500 outline-none"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-white/70 mb-2">Vehicle No.</label>
                                        <input
                                            type="text"
                                            value={registerData.vehicle}
                                            onChange={(e) => setRegisterData({ ...registerData, vehicle: e.target.value.toUpperCase() })}
                                            required
                                            placeholder="SMA1234B"
                                            className="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white placeholder-white/40 focus:ring-2 focus:ring-amber-500 outline-none"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-white/70 mb-2">Condo</label>
                                        <select
                                            value={registerData.condo}
                                            onChange={(e) => setRegisterData({ ...registerData, condo: e.target.value })}
                                            required
                                            className="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white focus:ring-2 focus:ring-amber-500 outline-none"
                                        >
                                            <option value="" className="bg-slate-800">Select condo...</option>
                                            {(USE_SUPABASE ? condosList : condoData).map(c => (
                                                <option key={c.name} value={c.name} className="bg-slate-800">{c.name}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-white/70 mb-2">Password</label>
                                        <input
                                            type="password"
                                            value={registerData.password}
                                            onChange={(e) => setRegisterData({ ...registerData, password: e.target.value })}
                                            required
                                            placeholder="••••••••"
                                            className="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white placeholder-white/40 focus:ring-2 focus:ring-amber-500 outline-none"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-white/70 mb-2">Confirm</label>
                                        <input
                                            type="password"
                                            value={registerData.confirmPassword}
                                            onChange={(e) => setRegisterData({ ...registerData, confirmPassword: e.target.value })}
                                            required
                                            placeholder="••••••••"
                                            className="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white placeholder-white/40 focus:ring-2 focus:ring-amber-500 outline-none"
                                        />
                                    </div>
                                </div>

                                <div className="bg-amber-500/10 border border-amber-500/30 rounded-lg p-3">
                                    <p className="text-amber-200 text-xs">
                                        <strong>Note:</strong> Your registration will be reviewed by admin. You will receive an email once your account is approved and linked to your condo's rebate tier.
                                    </p>
                                </div>

                                <button type="submit" disabled={isLoading} className="w-full bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 disabled:from-slate-500 disabled:to-slate-600 text-white font-bold py-4 px-6 rounded-xl shadow-lg transition-all flex items-center justify-center gap-2">
                                    {isLoading ? (
                                        <><div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin" />Registering...</>
                                    ) : (
                                        <><UserPlus className="w-5 h-5" />Submit Registration</>
                                    )}
                                </button>
                            </form>
                        )}

                        <p className="text-white/40 text-xs text-center mt-6">Powered by BYD MotorEast Singapore</p>
                    </div>
                </div>
            );
        };

        // Main App
        function App() {
            const [user, setUser] = useState(null);
            const [claims, setClaims] = useState(initialClaims);
            const [loading, setLoading] = useState(USE_SUPABASE);

            // Check for existing session on mount (Supabase mode)
            useEffect(() => {
                if (!USE_SUPABASE) return;

                const checkSession = async () => {
                    try {
                        const session = await db.getSession();
                        if (session?.user) {
                            const profile = await db.getProfile(session.user.id);
                            setUser({
                                id: session.user.id,
                                type: profile.role,
                                name: profile.name,
                                email: profile.email,
                                vehicle: profile.vehicle_number,
                                condo: profile.condo?.name || '',
                                condoId: profile.condo_id,
                                rebateRate: profile.condo?.rebate_rate || 0.10
                            });
                            // Load claims
                            if (profile.role === 'admin') {
                                const allClaims = await db.getAllClaims();
                                setClaims(allClaims);
                            }
                        }
                    } catch (err) {
                        console.error('Session check failed:', err);
                    }
                    setLoading(false);
                };

                checkSession();

                // Listen for auth changes
                const { data: { subscription } } = supabase.auth.onAuthStateChange(async (event, session) => {
                    if (event === 'SIGNED_OUT') {
                        setUser(null);
                        setClaims(initialClaims);
                    }
                });

                return () => subscription.unsubscribe();
            }, []);

            const handleLogout = async () => {
                if (USE_SUPABASE) {
                    await db.signOut();
                }
                setUser(null);
                setClaims(initialClaims);
            };

            if (loading) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 flex items-center justify-center">
                        <div className="text-center">
                            <div className="w-12 h-12 border-4 border-amber-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                            <p className="text-white/60">Loading...</p>
                        </div>
                    </div>
                );
            }

            if (!user) return <LoginScreen onLogin={setUser} setClaims={setClaims} />;
            if (user.type === 'admin') return <AdminDashboard claims={claims} setClaims={setClaims} onLogout={handleLogout} user={user} />;
            return <CustomerDashboard user={user} claims={claims} setClaims={setClaims} onLogout={handleLogout} />;
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
